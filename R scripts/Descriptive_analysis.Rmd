---
title: "Descriptive analysis"
output:
  html_document:
    latex_engine: xelatex
    toc: yes
    toc_depth: 2
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
font-family: Computer Modern
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r source_preprocessing_script, warning = FALSE, message = FALSE}
source("C:\\Users\\P70070766\\Documents\\Medication reconciliation\\Scripts\\20211027 - Preprocessing.R")
rm(list = setdiff(ls(), "data"))
```

```{r packages}
library(reactable)
```

# Table 1: sociodemographics

```{r descr.sociodemographics}
descr.sociodemographics.variable_name <- c("sex", 
                                           "age.cat",
                                           "education",
                                           "housing")

descr.sociodemographics <- matrix(ncol = 6)
colnames(descr.sociodemographics) <- c("variable",
                                       "cat", 
                                       "freq", 
                                       "freq.y",
                                       "freq.y.interaction",
                                       "freq.y.revision_wo_interaction")
for (i in 1:length(descr.sociodemographics.variable_name)) {
  variable_name <- descr.sociodemographics.variable_name[i]
  
  temp1 <- as.data.frame(table(data[[variable_name]], useNA = "always"))
  colnames(temp1)[1] <- "cat"
  colnames(temp1)[2] <- "freq"
  
  temp2 <- subset(
    as.data.frame(table(data[[variable_name]], data[["y"]], useNA = "always")),
    Var2 == 1) 
  temp2 <- temp2[, -2]
  colnames(temp2)[1] <- "cat"
  colnames(temp2)[2] <- "freq.y"
  
  temp3 <- subset(
    as.data.frame(table(data[[variable_name]], data[["y.interaction"]], useNA = "always")),
    Var2 == 1)
  temp3 <- temp3[, -2]
  colnames(temp3)[1] <- "cat"
  colnames(temp3)[2] <- "freq.y.interaction"
  
  temp4 <- subset(
    as.data.frame(table(data[[variable_name]], data[["y.revision_wo_interaction"]], useNA = "always")),
    Var2 == 1)
  temp4 <- temp4[, -2]
  colnames(temp4)[1] <- "cat"
  colnames(temp4)[2] <- "freq.y.revision_wo_interaction"
  
  temp <- merge(temp1, temp2, by = "cat")
  temp <- merge(temp, temp3, by = "cat")
  temp <- merge(temp, temp4, by = "cat")
  
  temp <- cbind(rep(variable_name, nrow(temp)), temp)
  colnames(temp)[1] <- "variable"
  
  descr.sociodemographics <- rbind(descr.sociodemographics, temp)
  }
descr.sociodemographics[5:15, 1] <- "age (categorised)" 
descr.sociodemographics[16:20, 1] <- "education*" 
descr.sociodemographics <- descr.sociodemographics[c(3, 2, 4:5, 7:14, 6, 15:20, 22, 21, 23:24), ]

reactable(descr.sociodemographics,
          columns = list(
            variable = colDef(name = "variable",
                              na = "NA"),
            cat = colDef(name = "category",,
                         na = "NA"),
            freq = colDef(name = "frequency",
                          na = "NA",
                          sortable = TRUE),
            freq.y = colDef(name = "frequency event", 
                            na = "NA",
                            sortable = TRUE),
            freq.y.interaction = colDef(name = "frequency medications interaction", 
                                        na = "NA",
                                        sortable = TRUE),
            freq.y.revision_wo_interaction = colDef(name = "frequency revision without medications interaction",
                                                    na = "NA",
                                                    sortable = TRUE)
            ),
          rownames = NULL,
          groupBy = "variable",
          sortable = FALSE,
          pagination = FALSE,
          resizable = TRUE,
          searchable = TRUE,
          bordered = TRUE,
          highlight = TRUE,
          showSortable = TRUE)
```

\*
type 1: elementary education (basisschool);
type 2: lower secondary education (lagere technische school, huishoudschool, middelbaar algemeen voortgezet onderwijs, meer uitgebreid lager onderwijs, voorbereidend middelbaar beroepsonderwijs);
type 3: upper secondary education (middelbaar beroepsonderwijs, hoger algemeen voortgezet onderwijs, hogereburgerschool);
type 4: upper secondary education/tertiary education (hogere technische school, hoger beroepsonderwijs, voorbereidend wetenschappelijk onderwijs, Wetenschappelijk onderwijs)

# Table 2: health

```{r descr.health}
descr.health.variable_name <- c("diseases",
                                "n_diseases",
                                "eGFR",
                                "allergy_medication")

descr.health <- matrix(ncol = 6)
colnames(descr.health) <- c("variable",
                            "cat", 
                            "freq", 
                            "freq.y",
                            "freq.y.interaction",
                            "freq.y.revision_wo_interaction")
for (i in 1:length(descr.health.variable_name)) {
  variable_name <- descr.health.variable_name[i]
  
  temp1 <- as.data.frame(table(data[[variable_name]], useNA = "always"))
  colnames(temp1)[1] <- "cat"
  colnames(temp1)[2] <- "freq"
  
  temp2 <- subset(
    as.data.frame(table(data[[variable_name]], data[["y"]], useNA = "always")),
    Var2 == 1) 
  temp2 <- temp2[, -2]
  colnames(temp2)[1] <- "cat"
  colnames(temp2)[2] <- "freq.y"
  
  temp3 <- subset(
    as.data.frame(table(data[[variable_name]], data[["y.interaction"]], useNA = "always")),
    Var2 == 1)
  temp3 <- temp3[, -2]
  colnames(temp3)[1] <- "cat"
  colnames(temp3)[2] <- "freq.y.interaction"
  
  temp4 <- subset(
    as.data.frame(table(data[[variable_name]], data[["y.revision_wo_interaction"]], useNA = "always")),
    Var2 == 1)
  temp4 <- temp4[, -2]
  colnames(temp4)[1] <- "cat"
  colnames(temp4)[2] <- "freq.y.revision_wo_interaction"
  
  temp <- merge(temp1, temp2, by = "cat")
  temp <- merge(temp, temp3, by = "cat")
  temp <- merge(temp, temp4, by = "cat")
  
  temp <- cbind(rep(variable_name, nrow(temp)), temp)
  colnames(temp)[1] <- "variable"
  
  descr.health <- rbind(descr.health, temp)
}
descr.health[11:18, 1] <- "number of diseases*"
descr.health[19:25, 1] <- "eGFR*"
descr.health[26:28, 1] <- "allergic to any medication"
descr.health <- descr.health[c(2:7, 9, 8, 10:19, 21:23, 20, 24, 27, 26, 28), ]

reactable(descr.health,
          columns = list(
            variable = colDef(name = "variable",
                              na = "NA"),
            cat = colDef(name = "category",,
                         na = "NA"),
            freq = colDef(name = "frequency",
                          na = "NA",
                          sortable = TRUE),
            freq.y = colDef(name = "frequency event", 
                            na = "NA",
                            sortable = TRUE),
            freq.y.interaction = colDef(name = "frequency medications interaction", 
                                        na = "NA",
                                        sortable = TRUE),
            freq.y.revision_wo_interaction = colDef(name = "frequency revision without medications interaction",
                                                    na = "NA",
                                                    sortable = TRUE)
            ),
          rownames = NULL,
          groupBy = "variable",
          sortable = FALSE,
          pagination = FALSE,
          resizable = TRUE,
          searchable = TRUE,
          bordered = TRUE,
          highlight = TRUE,
          showSortable = TRUE)
```

# Table 3: medications


```{r medications}
descr.medications.variable_name <- c("patient_reported_medication_use",
                                     "high_risk_medications.yes_1",
                                     "high_risk_medications.cat",
                                     "medication_without_prescription",
                                     "n_medications",
                                     "medication_literacy",
                                     "person_responsible_for_medications",
                                     "pill_box.week")
descr.medications <- matrix(ncol = 6)
colnames(descr.medications) <- c("variable",
                                 "cat", 
                                 "freq",
                                 "freq.y",
                                 "freq.y.interaction",
                                 "freq.y.revision_wo_interaction")
for (i in 1:length(descr.medications.variable_name)) {
  variable_name <- descr.medications.variable_name[i]
  
  temp1 <- as.data.frame(table(data[[variable_name]], useNA = "always"))
  colnames(temp1)[1] <- "cat"
  colnames(temp1)[2] <- "freq"
  
  temp2 <- subset(
    as.data.frame(table(data[[variable_name]], data[["y"]], useNA = "always")),
    Var2 == 1) 
  temp2 <- temp2[, -2]
  colnames(temp2)[1] <- "cat"
  colnames(temp2)[2] <- "freq.y"
  
  temp3 <- subset(
    as.data.frame(table(data[[variable_name]], data[["y.interaction"]], useNA = "always")),
    Var2 == 1)
  temp3 <- temp3[, -2]
  colnames(temp3)[1] <- "cat"
  colnames(temp3)[2] <- "freq.y.interaction"
  
  temp4 <- subset(
    as.data.frame(table(data[[variable_name]], data[["y.revision_wo_interaction"]], useNA = "always")),
    Var2 == 1)
  temp4 <- temp4[, -2]
  colnames(temp4)[1] <- "cat"
  colnames(temp4)[2] <- "freq.y.revision_wo_interaction"
  
  temp <- merge(temp1, temp2, by = "cat")
  temp <- merge(temp, temp3, by = "cat")
  temp <- merge(temp, temp4, by = "cat")

  temp <- cbind(rep(variable_name, nrow(temp)), temp)
  colnames(temp)[1] <- "variable"
  
  descr.medications <- rbind(descr.medications, temp)
}
descr.medications[2:4, 1] <- "patient-reported medication use"
descr.medications[5:7, 1] <- "any high risk medications"
descr.medications[8:20, 1] <- "high-risk medications"
descr.medications[21:28, 1] <- "medications without prescription"
descr.medications[29:50, 1] <- "number of medications"
descr.medications[51:54, 1] <- "medication literacy"
descr.medications[55:58, 1] <- "person responsible for medications"
descr.medications[59:61, 1] <- "pill box"
descr.medications[5, 2] <- "no"
descr.medications[6, 2] <- "yes"

descr.medications <- descr.medications[c(3, 2, 4, 6, 5, 7, 8:12, 14:19, 13, 21:23, 26:27, 25, 24, 28:30, 41, 43:49, 31:40, 42, 50:51, 53, 52, 54, 57, 56, 55, 58, 60, 59, 61), ]

reactable(descr.medications,
          columns = list(
            variable = colDef(name = "variable",
                              na = "NA"),
            cat = colDef(name = "category",
                         na = "NA"),
            freq = colDef(name = "frequency",
                          na = "NA",
                          sortable = TRUE),
            freq.y = colDef(name = "frequency event", 
                            na = "NA",
                            sortable = TRUE),
            freq.y.interaction = colDef(name = "frequency medications interaction", 
                                        na = "NA",
                                        sortable = TRUE),
            freq.y.revision_wo_interaction = colDef(name = "frequency revision without medications interaction",
                                                    na = "NA",
                                                    sortable = TRUE)
            ),
          rownames = NULL,
          groupBy = "variable",
          sortable = FALSE,
          pagination = FALSE,
          resizable = TRUE,
          searchable = TRUE,
          bordered = TRUE,
          highlight = TRUE,
          showSortable = TRUE)
```

# Table 4: MUMC+ hospital use

# Table 5: external hospital use